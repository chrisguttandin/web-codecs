import type { createNativeAudioDecoderConstructor } from './native-audio-decoder-constructor';
import type { createNativeEncodedAudioChunkConstructor } from './native-encoded-audio-chunk-constructor';

export const createTestFlacDecodingSupport =
    (
        nativeAudioDecoderConstructor: ReturnType<typeof createNativeAudioDecoderConstructor>,
        nativeEncodedAudioChunkConstructor: ReturnType<typeof createNativeEncodedAudioChunkConstructor>
    ) =>
    async () => {
        if (nativeAudioDecoderConstructor === null || nativeEncodedAudioChunkConstructor === null) {
            return false;
        }

        // tslint:disable-next-line no-empty
        const audioDecoder = new nativeAudioDecoderConstructor({ error: () => {}, output: () => {} });

        audioDecoder.configure({
            codec: 'flac',
            description: new Uint8Array([
                102, 76, 97, 67, 0, 0, 0, 34, 18, 0, 18, 0, 0, 0, 186, 0, 5, 57, 11, 184, 0, 240, 0, 3, 169, 128, 148, 172, 171, 223, 193,
                198, 120, 195, 117, 49, 236, 130, 87, 47, 118, 114
            ]),
            numberOfChannels: 1,
            sampleRate: 48000
        });
        audioDecoder.decode(
            new nativeEncodedAudioChunkConstructor({
                data: new Uint8Array([
                    255, 248, 90, 8, 0, 129, 78, 0, 0, 2, 22, 4, 36, 6, 30, 7, 255, 9, 189, 11, 79, 12, 177, 230, 178, 110, 13, 141, 229,
                    150, 228, 135, 163, 226, 35, 68, 168, 121, 99, 0, 9, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146,
                    121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50,
                    146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41,
                    50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228,
                    41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144,
                    228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39,
                    144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147,
                    39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60,
                    147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204,
                    60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161,
                    204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73,
                    161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147,
                    73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156,
                    147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39,
                    156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41,
                    39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147,
                    41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66,
                    147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14,
                    66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121,
                    14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50,
                    121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201,
                    50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195,
                    201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28,
                    195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154,
                    28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52,
                    154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201,
                    52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121,
                    201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146,
                    121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50,
                    146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41,
                    50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228,
                    41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144,
                    228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39,
                    144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147,
                    39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60,
                    147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204,
                    60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161,
                    204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73,
                    161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156, 147,
                    73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39, 156,
                    147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41, 39,
                    156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147, 41,
                    39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66, 147,
                    41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14, 66,
                    147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121, 14,
                    66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50, 121,
                    14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201, 50,
                    121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195, 201,
                    50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28, 195,
                    201, 50, 121, 14, 66, 147, 41, 39, 156, 147, 73, 161, 204, 60, 147, 39, 144, 228, 41, 50, 146, 121, 201, 52, 154, 28,
                    195, 201, 50, 121, 12, 214, 252
                ]),
                duration: 96000,
                timestamp: 0,
                type: 'key'
            })
        );

        try {
            await audioDecoder.flush();

            return true;
        } catch {
            return false;
        } finally {
            try {
                audioDecoder.close();
            } catch {
                // Ignore errors.
            }
        }
    };
